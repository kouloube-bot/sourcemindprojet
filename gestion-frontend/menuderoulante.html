<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Publications</title>
    <link rel="stylesheet" href="asset/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            display: flex;
            padding: 0;
            margin: 0;
            max-width: 100%;
        }

        .sidebar {
            width: 250px;
            min-height: 100vh;
            background-color: #333;
            padding: 20px;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }

        .sidebar a:hover {
            background-color: #555;
            border-radius: 5px;
        }

        .sidebar i {
            margin-right: 10px;
        }

        .content {
            flex: 1;
            padding: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover {
            color: #000;
        }

        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Style pour les toasts */
        .toast {
            background-color: white;
            margin-bottom: 10px;
        }

        .toast.bg-success, .toast.bg-danger {
            color: white;
        }

        .toast-header {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .toast-body {
            padding: 0.75rem;
        }

        .toast-container {
            z-index: 1500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="menuderoulante.html"><i class="bi bi-file-earmark-text"></i>Publications</a>
            <a href="listeRoles.html"><i class="bi bi-gear"></i>Gestion des Rôles</a>
            <a href="listeutilisateur.html"><i class="bi bi-people"></i>Gestion des Utilisateurs</a>
            <a href="listeDepartement.html"><i class="bi bi-building"></i>Gestion des Départements</a>
            <a href="listeChercheur.html"><i class="bi bi-people"></i>Gestion des Enseignants</a>
            <a href="parametres.html"><i class="bi bi-gear"></i>Paramètres</a>
        </div>

        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <div class="profile-section">
                    <div class="profile-image">
                        <i class="bi bi-person"></i>
                    </div>
                    <div>
                        <h5 class="mb-0"></h5>
                        <small class="text-muted">Administrateur</small>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn-action">
                        <div class="mt-auto text-center">
                            <a href="#" id="logout-link" class="text-danger">
                                <i class="bi bi-box-arrow-left"></i> Déconnexion
                            </a>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <h1>Gestion des Publications</h1>

                <!-- Nav tabs -->
                <ul class="nav nav-tabs mb-3" id="publicationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="valides-tab" data-bs-toggle="tab" data-bs-target="#valides" 
                                type="button" role="tab" aria-controls="valides" aria-selected="true"
                                onclick="filterPublications('valides')">
                                <i class="bi bi-check-circle"></i> Publications Validées
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="en-revision-tab" data-bs-toggle="tab" data-bs-target="#en-revision" 
                                type="button" role="tab" aria-controls="en-revision" aria-selected="false"
                                onclick="filterPublications('en-revision')">
                            En cours de révision
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="revisionfalse-tab" data-bs-toggle="tab" data-bs-target="#revisionfalse" 
                                type="button" role="tab" aria-controls="revisionfalse" aria-selected="false"
                                onclick="fetchRevisionsNonEffectuees()">
                                <i class="bi bi-pencil"></i> Révisions Non Effectuées
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="revisiontrue-tab" data-bs-toggle="tab" data-bs-target="#revisiontrue" 
                                type="button" role="tab" aria-controls="revisiontrue" aria-selected="false"
                                onclick="fetchRevisionsEffectuees()">
                                <i class="bi bi-pencil"></i> Révisions Effectuées
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="soumis-tab" data-bs-toggle="tab" data-bs-target="#soumis" 
                                type="button" role="tab" aria-controls="soumis" aria-selected="false"
                                onclick="filterPublications('soumis')">
                                <i class="bi bi-hourglass"></i> Publications Soumises
                        </button>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <!-- Publications Validées -->
                    <div class="tab-pane fade" id="valides" role="tabpanel" aria-labelledby="valides-tab">
                        <h4>Publications Validées</h4>
                    </div>

                    <!-- Publications en révision -->
                    <div class="tab-pane fade" id="en-revision" role="tabpanel" aria-labelledby="en-revision-tab">
                        <h4>Publications en Cours de Révision</h4>
                    </div>

                    <!-- Révisions non effectuées -->
                    <div class="tab-pane fade" id="revisionfalse" role="tabpanel" aria-labelledby="revisionfalse-tab">
                        <h4>Révisions Non Effectuées</h4>
                    </div>

                    <!-- Révisions effectuées -->
                    <div class="tab-pane fade" id="revisiontrue" role="tabpanel" aria-labelledby="revisiontrue-tab">
                        <h4>Révisions Effectuées</h4>
                    </div>

                    <!-- Publications soumises -->
                    <div class="tab-pane fade show active" id="soumis" role="tabpanel" aria-labelledby="soumis-tab">
                        <h4>Publications Soumises</h4>
                        <div id="affecter-btn-container">
                            <button class="btn btn-primary" onclick="openModal()">Affecter</button>
                        </div>
                    </div>
                </div>

                <!-- Modal d'affectation -->
                <div id="affecter-modal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal()">&times;</span>
                        <h2>Affecter une publication</h2>
                        <label for="publication-select">Choisir une publication :</label>
                        <select id="publication-select" class="form-select"></select>
                        <label for="reviseur-select">Choisir un réviseur :</label>
                        <select id="reviseur-select" class="form-select"></select>
                        <button id="confirm-affecter-btn" class="btn btn-primary mt-3" onclick="affecterPublication()">Affecter</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2"></i>
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message"></div>
        </div>
    </div>

<script>
// Variables globales
let currentStatus = 'soumis';
let isLoading = false;

// Fonction pour afficher un toast
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    const toastInstance = new bootstrap.Toast(toast, {
        delay: 3000 // Disparaît après 3 secondes
    });

    // Configurer l'apparence selon le type
    toast.classList.remove('bg-success', 'bg-danger', 'bg-info', 'text-white');
    const header = toast.querySelector('.toast-header');
    header.classList.remove('bg-success', 'bg-danger', 'bg-info', 'text-white');
    const icon = header.querySelector('i');
    icon.classList.remove('bi-check-circle', 'bi-x-circle', 'bi-info-circle');

    switch(type) {
        case 'success':
            toast.classList.add('text-white');
            header.classList.add('bg-success', 'text-white');
            icon.classList.add('bi-check-circle');
            toastTitle.textContent = 'Succès';
            break;
        case 'error':
            toast.classList.add('text-white');
            header.classList.add('bg-danger', 'text-white');
            icon.classList.add('bi-x-circle');
            toastTitle.textContent = 'Erreur';
            break;
        default:
            header.classList.add('bg-info', 'text-white');
            icon.classList.add('bi-info-circle');
            toastTitle.textContent = 'Information';
    }

    toastMessage.textContent = message;
    toastInstance.show();
}

// Fonction pour gérer l'état de chargement
function toggleLoadingState(loading) {
    isLoading = loading;
    const confirmBtn = document.getElementById('confirm-affecter-btn');
    if (confirmBtn) {
        confirmBtn.disabled = loading;
        confirmBtn.innerHTML = loading ? 
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Chargement...' : 
            'Affecter';
    }
}

// Fonction pour filtrer les publications
async function filterPublications(status) {
    currentStatus = status;
    await fetchPublications(status);
    const tab = new bootstrap.Tab(document.getElementById(`${status}-tab`));
    tab.show();
}

// Fonction pour récupérer les publications
async function fetchPublications(status = currentStatus) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    try {
        const response = await fetch(`http://localhost:8090/${status}/all`, {
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Erreur réseau');
        const publications = await response.json();
        displayPublications(publications, status);
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors du chargement des publications', 'error');
    }
}

// Fonction pour afficher les publications
function displayPublications(publications, status) {
    const containers = {
        valides: document.getElementById('valides'),
        'en-revision': document.getElementById('en-revision'),
        soumis: document.getElementById('soumis')
    };

    const container = containers[status];
    if (!container) return;

    if (!publications || publications.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                Aucune publication ${status === 'valides' ? 'validée' : 
                                   status === 'en-revision' ? 'en cours de révision' : 
                                   'soumise'} n'a été trouvée.
            </div>`;
        return;
    }

    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Résumé</th>
                    <th>Status</th>
                    <th>Utilisateur</th>
                    <th>Fichier</th>
                </tr>
            </thead>
            <tbody>
                ${publications.map(pub => `
                    <tr>
                        <td>${pub.titre || 'N/A'}</td>
                        <td>${pub.resume || 'N/A'}</td>
                        <td>${pub.status || 'N/A'}</td>
                        <td>${pub.utilisateur?.enseignantChercheur?.nom || 'Nom inconnu'}</td>
                        <td>${pub.fichierPDF ? 
                            `<a href="${pub.fichierPDF}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-file-pdf"></i> Voir le PDF
                             </a>` : 
                            'Pas de fichier'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;

    // Réajouter le bouton Affecter pour l'onglet soumis
    if (status === 'soumis') {
        container.innerHTML += `
            <div id="affecter-btn-container">
                <button class="btn btn-primary" onclick="openModal()">Affecter</button>
            </div>`;
    }
}

// Fonction pour récupérer les révisions non effectuées
async function fetchRevisionsNonEffectuees() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    try {
        const response = await fetch('http://localhost:8090/revisionfalse/all', {
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Erreur réseau');
        const revisions = await response.json();
        displayRevisionsNonEffectuees(revisions);
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors du chargement des révisions non effectuées', 'error');
    }
}

// Fonction pour afficher les révisions non effectuées
function displayRevisionsNonEffectuees(revisions) {
    const container = document.getElementById('revisionfalse');
    if (!container) return;

    if (!revisions || revisions.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                Aucune révision non effectuée n'a été trouvée.
            </div>`;
        return;
    }

    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Résumé</th>
                    <th>Status</th>
                    <th>Utilisateur</th>
                    <th>Fichier</th>
                    <th>Effectuée</th>
                </tr>
            </thead>
            <tbody>
                ${revisions.map(revision => `
                    <tr>
                        <td>${revision.publication?.titre || 'N/A'}</td>
                        <td>${revision.publication?.resume || 'N/A'}</td>
                        <td>${revision.publication?.status || 'N/A'}</td>
                        <td>${revision.utilisateur?.enseignantChercheur?.nom || 'Nom inconnu'}</td>
                        <td>${revision.publication?.fichierPDF ? 
                            `<a href="${revision.publication.fichierPDF}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-file-pdf"></i> Voir le PDF
                             </a>` : 
                            'Pas de fichier'}</td>
                        <td>${revision.effectuee ? 'Oui' : 'Non'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

// Fonction pour récupérer les révisions effectuées
async function fetchRevisionsEffectuees() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    try {
        const response = await fetch('http://localhost:8090/revisiontrue/all', {
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Erreur réseau');
        const revisions = await response.json();
        displayRevisionsEffectuees(revisions);
    } catch (error) {
        
        showToast('Erreur lors du chargement des révisions effectuées', 'error');
    }
}

// Fonction pour afficher les révisions effectuées
function displayRevisionsEffectuees(revisions) {
    const container = document.getElementById('revisiontrue');
    if (!container) return;

    if (!revisions || revisions.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                Aucune révision effectuée n'a été trouvée.
            </div>`;
        return;
    }

    container.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Résumé</th>
                    <th>Status</th>
                    <th>Utilisateur</th>
                    <th>Fichier</th>
                    <th>Effectuée</th>
                    <th>Commentaire</th>
                    <th>Note</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                ${revisions.map(revision => `
                    <tr>
                        <td>${revision.publication?.titre || 'N/A'}</td>
                        <td>${revision.publication?.resume || 'N/A'}</td>
                        <td>${revision.publication?.status || 'N/A'}</td>
                        <td>${revision.utilisateur?.enseignantChercheur?.nom || 'Nom inconnu'}</td>
                        <td>${revision.publication?.fichierPDF ? 
                            `<a href="${revision.publication.fichierPDF}" target="_blank" class="btn btn-sm btn-primary">
                                <i class="bi bi-file-pdf"></i> Voir le PDF
                             </a>` : 
                            'Pas de fichier'}</td>
                        <td>${revision.effectuee ? 'Oui' : 'Non'}</td>
                        <td>${revision.commentaires || 'Aucun commentaire'}</td>
                        <td>${revision.note || 'Non notée'}</td>
                        <td>
                            <button onclick="validerPublication(${revision.idRevision})" 
                                    class="btn btn-success btn-sm">
                                <i class="bi bi-check-circle"></i> Valider
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

// Fonction pour valider une publication
async function validerPublication(idRevision) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    if (!confirm('Êtes-vous sûr de vouloir valider cette publication ?')) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:8090/valider/${idRevision}`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Erreur lors de la validation');
        
        await fetchRevisionsEffectuees();
        showToast('Publication validée avec succès', 'success');
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de la validation', 'error');
    }
}

// Fonction pour charger les données du modal
async function fetchModalData() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    toggleLoadingState(true);

    try {
        const headers = {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };

        const [pubResponse, revResponse] = await Promise.all([
            fetch('http://localhost:8090/soumis/all', { headers }),
            fetch('http://localhost:8090/reviseurs/all', { headers })
        ]);

        if (!pubResponse.ok || !revResponse.ok) throw new Error('Erreur réseau');

        const [publications, reviseurs] = await Promise.all([
            pubResponse.json(),
            revResponse.json()
        ]);

        populateSelects(publications, reviseurs);
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors du chargement des données', 'error');
        closeModal();
    } finally {
        toggleLoadingState(false);
    }
}

// Fonction pour peupler les select du modal
function populateSelects(publications, reviseurs) {
    const publicationSelect = document.getElementById('publication-select');
    const reviseurSelect = document.getElementById('reviseur-select');

    publicationSelect.innerHTML = '<option value="">Choisissez une publication</option>';
    reviseurSelect.innerHTML = '<option value="">Choisissez un réviseur</option>';

    publications.forEach(pub => {
        publicationSelect.innerHTML += `
            <option value="${pub.idPublication}">${pub.titre}</option>`;
    });

    reviseurs.forEach(rev => {
        const revisorId = rev.id || rev.idUtilisateur || rev.utilisateur?.id;
        const revisorEmail = rev.email || rev.utilisateur?.email;
        
        if (revisorId && revisorEmail) {
            reviseurSelect.innerHTML += `
                <option value="${revisorId}">${revisorEmail}</option>`;
        }
    });
}

// Fonction pour affecter une publication
async function affecterPublication() {
    if (isLoading) return;

    const publicationSelect = document.getElementById('publication-select');
    const reviseurSelect = document.getElementById('reviseur-select');

    if (!publicationSelect.value || !reviseurSelect.value) {
        showToast("Veuillez sélectionner une publication et un réviseur", "error");
        return;
    }

    const idPublication = parseInt(publicationSelect.value);
    const idUtilisateur = parseInt(reviseurSelect.value);

    if (isNaN(idPublication) || isNaN(idUtilisateur)) {
        showToast("Sélection invalide", "error");
        return;
    }

    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }

    toggleLoadingState(true);

    try {
        const response = await fetch('http://localhost:8090/revision/affecterReviseur', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ idPublication, idUtilisateur })
        });

        if (!response.ok) {
            throw new Error('Erreur lors de l\'affectation');
        }

        showToast('Publication affectée avec succès', 'success');
        closeModal();

        // Rafraîchir les données
        setTimeout(async () => {
            await Promise.all([
                fetchPublications('soumis'),
                fetchPublications('en-revision')
            ]);
        }, 200);

    } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors de l\'affectation', 'error');
    } finally {
        toggleLoadingState(false);
    }
}

// Fonctions pour gérer le modal
function openModal() {
    if (!isLoading) {
        document.getElementById('affecter-modal').style.display = 'block';
        fetchModalData();
    }
}

function closeModal() {
    if (!isLoading) {
        document.getElementById('affecter-modal').style.display = 'none';
        const publicationSelect = document.getElementById('publication-select');
        const reviseurSelect = document.getElementById('reviseur-select');
        if (publicationSelect) publicationSelect.selectedIndex = 0;
        if (reviseurSelect) reviseurSelect.selectedIndex = 0;
    }
}

// Fermer le modal en cliquant en dehors
window.onclick = function(event) {
    const modal = document.getElementById('affecter-modal');
    if (event.target === modal && !isLoading) {
        closeModal();
    }
}

// Gestion de la déconnexion
document.getElementById("logout-link").addEventListener("click", function(e) {
    e.preventDefault();
    localStorage.removeItem("token");
    localStorage.removeItem("role");
    window.location.href = "login.html";
});

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = "login.html";
        return;
    }
    filterPublications(currentStatus);
});
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="asset/js/appChercheur.js"></script>
</body>
</html>